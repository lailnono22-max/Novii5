# إعداد ميزة تعديل وحذف الرسائل - Supabase Setup

## نظرة عامة
تمت إضافة ميزة تعديل وحذف الرسائل في نظام المراسلة. يتطلب هذا تحديث قاعدة البيانات لإضافة حقول جديدة ودوال SQL.

## الخطوات المطلوبة

### 1. تحديث قاعدة بيانات Supabase

قم بتشغيل ملف SQL التالي في **Supabase SQL Editor**:

#### الملف: `supabase_messages_edit_delete.sql`

هذا الملف يقوم بـ:
- إضافة حقول جديدة لجدول `messages`:
  - `is_deleted` (Boolean): للإشارة إلى الرسائل المحذوفة
  - `is_edited` (Boolean): للإشارة إلى الرسائل المعدلة
  - `edited_at` (Timestamp): تاريخ آخر تعديل
  - `original_content` (Text): المحتوى الأصلي قبل التعديل

- إضافة دوال SQL:
  - `update_message(message_id, new_content)`: لتعديل الرسالة
  - `delete_message(message_id)`: للحذف الناعم للرسالة

- إضافة RLS Policies للأمان:
  - يمكن للمرسل فقط تعديل أو حذف رسائله
  - الحذف الصلب ممنوع (نستخدم الحذف الناعم)

### 2. خطوات التنفيذ

⚠️ **مهم**: إذا كنت قد شغلت السكريبت من قبل، لا تقلق! السكريبت الجديد يحذف الدوال القديمة تلقائياً ويعيد إنشائها.

1. افتح **Supabase Dashboard** الخاص بمشروعك
2. اذهب إلى **SQL Editor**
3. انسخ محتوى ملف `supabase_messages_edit_delete.sql` كاملاً
4. الصق المحتوى في SQL Editor
5. اضغط **Run** لتشغيل السكريبت

✅ إذا ظهر لك خطأ "cannot change return type"، قم بتشغيل السكريبت المحدث مرة أخرى - السكريبت الجديد يحتوي على أوامر DROP لحذف الدوال القديمة أولاً.

### 3. التحقق من نجاح التنفيذ

بعد تشغيل السكريبت، تأكد من:
- ✅ تمت إضافة الحقول الجديدة إلى جدول `messages`
- ✅ تم إنشاء دالتين: `update_message` و `delete_message`
- ✅ تم إنشاء Indexes للحقول الجديدة

يمكنك التحقق من ذلك عبر:
```sql
-- التحقق من الحقول الجديدة
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'messages';

-- التحقق من الدوال
SELECT proname 
FROM pg_proc 
WHERE proname IN ('update_message', 'delete_message');
```

## الميزات الجديدة

### للمستخدمين:

1. **تعديل الرسالة**: 
   - انقر على أيقونة ⋮ (three dots) على رسالتك
   - اختر "تعديل" أو "Edit"
   - قم بتعديل النص واضغط ✓
   - سيظهر مؤشر "محررة" / "edited" على الرسالة

2. **حذف الرسالة**:
   - انقر على أيقونة ⋮ (three dots) على رسالتك  
   - اختر "حذف" أو "Delete"
   - أكد الحذف
   - سيتم استبدال الرسالة بـ "تم حذف هذه الرسالة"

3. **التحديث الفوري**:
   - جميع التعديلات والحذف تظهر فوراً عند الطرف الآخر
   - دون الحاجة لتحديث الصفحة

## ملاحظات فنية

- **الحذف الناعم (Soft Delete)**: الرسائل المحذوفة لا يتم حذفها من قاعدة البيانات، بل يتم وضع علامة `is_deleted = true` عليها
- **الأمان**: يتم التحقق من صلاحيات المستخدم - فقط المرسل يمكنه تعديل أو حذف رسائله
- **Real-time**: يتم استخدام Supabase Real-time لتحديث الرسائل فوراً عند الطرفين
- **التعديل الأول**: عند أول تعديل للرسالة، يتم حفظ المحتوى الأصلي في `original_content`

## استكشاف الأخطاء

إذا لم تعمل الميزة:

1. تأكد من تشغيل `supabase_messages_edit_delete.sql` بنجاح
2. تحقق من console في المتصفح للتأكد من عدم وجود أخطاء JavaScript
3. تأكد من أن Real-time enabled في Supabase لجدول `messages`
4. تحقق من RLS Policies في Supabase

## دعم اللغة العربية

- جميع الواجهات تدعم RTL (Right-to-Left)
- النصوص متاحة بالعربية والإنجليزية
- التوجيه يتغير تلقائياً حسب اللغة المختارة
